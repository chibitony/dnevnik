<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой Дневник Настроения</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN для графиков -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Tone.js CDN для звуковой обратной связи (тихий "клик") -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Цветовая схема по умолчанию (Лаванда) - ОЧЕНЬ НЕЖНАЯ */
        :root {
            --p-bg: #F9FAFF; 
            --p-text: #585098; 
            --p-accent: #B39DDB; 
            --p-accent-light: #EFE7FC; 
            --p-bg-card: #FFFFFF;
        }

        /* Универсальный класс для плавных переходов */
        .smooth-transition { 
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--p-bg);
            color: #333;
        }
        
        /* Стили для интерактивных элементов */
        .tab-button, .nav-button, .chart-period-button, .rating-option, .day-cell, 
        .shadow-md, .shadow-lg, [onclick], button { 
             transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Динамические цвета для Tailwind-классов */
        .dynamic-text { color: var(--p-text); }
        .dynamic-bg { background-color: var(--p-accent); }
        .dynamic-bg-light { background-color: var(--p-accent-light); }
        .dynamic-border { border-color: var(--p-accent); }
        .dynamic-hover-bg:hover { background-color: var(--p-accent-light); }
        .dynamic-hover-scale:hover { transform: scale(1.02); }

        .tab-button {
            border-radius: 9999px; 
            color: var(--p-text);
        }
        .tab-button.active {
            background-color: var(--p-accent-light);
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Стили для выбора настроения и стресса */
        .rating-option, .stress-option {
            border: 2px solid var(--p-accent);
            color: var(--p-text);
            cursor: pointer;
            border-radius: 9999px;
            padding: 8px 16px;
            font-weight: 600;
            user-select: none;
        }
        .rating-option:hover, .stress-option:hover {
            transform: scale(1.05);
        }
        .rating-option.selected, .stress-option.selected {
            background-color: var(--p-accent);
            color: white;
            transform: scale(1.1);
            border-color: var(--p-accent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Стили для ячеек календаря */
        .day-cell {
            padding: 8px 4px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            min-height: 40px;
            position: relative; 
            cursor: pointer;
        }
        .day-cell:hover {
            opacity: 0.9;
            box-shadow: 0 0 0 2px var(--p-text), 0 4px 6px rgba(0,0,0,0.1); 
        }
        .day-cell.has-data {
            border: 2px solid var(--p-accent);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .day-cell.is-today {
            box-shadow: 0 0 0 3px var(--p-accent);
        }
        .day-cell.selected-day {
            background-color: var(--p-accent);
            color: white;
        }

        /* Анимация перехода между видами */
        .view-content {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .view-content.active-view {
            opacity: 1;
            transform: translateY(0);
        }

        /* Стили для Range Input */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: var(--p-accent-light);
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--p-accent);
            border: 4px solid var(--p-bg);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.3s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--p-accent);
            border: 4px solid var(--p-bg);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.3s;
        }
        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        /* Стили для Chart.js */
        #mood-chart-container {
            max-height: 300px;
        }
        
        /* Стили для Markdown-контента */
        #ai-analysis-output p, #ai-analysis-output ul {
            margin-bottom: 0.75rem;
        }
        #ai-analysis-output ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Основной контейнер приложения -->
    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center py-6">
            <h1 class="text-3xl font-extrabold dynamic-text">Дневник Настроения</h1>
            <p class="text-gray-500 mt-1">Отслеживайте свои эмоции и получайте анализ от Gemini AI</p>
        </header>

        <!-- Меню вкладок -->
        <nav class="flex justify-around bg-white p-2 rounded-full shadow-lg mb-6">
            <!-- Уменьшаем px-4 до px-3 на всех кнопках для экономии места на мобильных -->
            <button class="tab-button active flex-1 py-2 px-3 text-sm md:text-base smooth-transition" data-view="input" onclick="switchView('input')">Запись</button>
            <button class="tab-button flex-1 py-2 px-3 text-sm md:text-base smooth-transition" data-view="calendar" onclick="switchView('calendar')">Календарь</button>
            <button class="tab-button flex-1 py-2 px-3 text-sm md:text-base smooth-transition" data-view="charts" onclick="switchView('charts')">Аналитика</button>
            <!-- Убираем text-lg с мобильной версии для иконки, чтобы она не расширяла кнопку -->
            <button class="tab-button flex-1 py-2 px-3 text-sm md:text-base smooth-transition" data-view="settings" onclick="switchView('settings')" title="Настройки">&#x2699;</button>
        </nav>

        <!-- --- ВИД 1: ВВОД ДАННЫХ --- -->
        <div id="view-input" class="view-content active-view space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-xl smooth-transition">
                <h2 class="text-2xl font-bold mb-4 dynamic-text">Новая Запись</h2>
                
                <!-- Date Picker - НОВОЕ! -->
                <div class="mb-6">
                    <label for="log-date" class="block text-gray-700 font-semibold mb-2">Дата записи (по умолчанию - сегодня)</label>
                    <input type="date" id="log-date" class="w-full p-3 border rounded-xl focus:ring-2 dynamic-border focus:ring-purple-300 smooth-transition">
                </div>

                <!-- Рейтинг Настроения (1-5) -->
                <div class="mb-6 border-b pb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Настроение (1 - Ужасно, 5 - Великолепно)</label>
                    <div id="mood-rating" class="flex justify-between space-x-2">
                        <div class="rating-option flex-1 text-center" data-mood="1" onclick="selectMood(1)">1</div>
                        <div class="rating-option flex-1 text-center" data-mood="2" onclick="selectMood(2)">2</div>
                        <div class="rating-option selected flex-1 text-center" data-mood="3" onclick="selectMood(3)">3</div>
                        <div class="rating-option flex-1 text-center" data-mood="4" onclick="selectMood(4)">4</div>
                        <div class="rating-option flex-1 text-center" data-mood="5" onclick="selectMood(5)">5</div>
                    </div>
                    <p id="mood-label" class="text-center mt-2 text-lg font-medium dynamic-text smooth-transition">Нормально</p>
                </div>
                
                <!-- Рейтинг Стресса (1-5) - НОВОЕ! -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Уровень Стресса (1 - Низкий, 5 - Критический)</label>
                    <div id="stress-rating" class="flex justify-between space-x-2">
                        <div class="stress-option flex-1 text-center" data-stress="1" onclick="selectStress(1)">1</div>
                        <div class="stress-option flex-1 text-center" data-stress="2" onclick="selectStress(2)">2</div>
                        <div class="stress-option selected flex-1 text-center" data-stress="3" onclick="selectStress(3)">3</div>
                        <div class="stress-option flex-1 text-center" data-stress="4" onclick="selectStress(4)">4</div>
                        <div class="stress-option flex-1 text-center" data-stress="5" onclick="selectStress(5)">5</div>
                    </div>
                    <p id="stress-label" class="text-center mt-2 text-lg font-medium dynamic-text smooth-transition">Умеренный</p>
                </div>

                <!-- Текстовое описание -->
                <div class="mb-6">
                    <label for="mood-notes" class="block text-gray-700 font-semibold mb-2">Что произошло? (Обязательно)</label>
                    <textarea id="mood-notes" rows="4" class="w-full p-3 border rounded-xl focus:ring-2 dynamic-border focus:ring-purple-300 smooth-transition" placeholder="Опишите свои чувства и события дня..."></textarea>
                </div>
                
                <!-- Кнопка сохранения -->
                <button onclick="saveLog()" class="w-full py-3 rounded-xl text-white font-bold text-lg dynamic-bg hover:opacity-90 smooth-transition shadow-lg">
                    Сохранить Запись
                </button>
                
                <!-- Сообщение об ошибке/успехе -->
                <div id="message-box" class="mt-4 text-center p-3 rounded-lg hidden smooth-transition"></div>
            </div>
            
            <!-- Секция Анализа от AI (для отображения после сохранения) -->
            <div id="ai-analysis-container" class="bg-white p-6 rounded-2xl shadow-xl mt-6 hidden smooth-transition">
                <h2 class="text-2xl font-bold mb-4 dynamic-text">Анализ Gemini AI</h2>
                <div id="ai-analysis-output" class="text-gray-700 space-y-3">
                    <!-- Здесь будет сгенерированный текст -->
                </div>
                <div id="ai-citation-container" class="mt-4 text-sm text-gray-500 border-t pt-3 hidden">
                    <p class="font-semibold mb-1">Источники:</p>
                    <ul id="ai-citation-list" class="list-disc list-inside space-y-1"></ul>
                </div>
                <div id="ai-loading" class="text-center py-4 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-r-2 dynamic-border inline-block"></div>
                    <p class="mt-2 text-gray-500">Генерация отчета...</p>
                </div>
            </div>
        </div>

        <!-- --- ВИД 2: КАЛЕНДАРЬ --- -->
        <div id="view-calendar" class="view-content hidden space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-xl smooth-transition">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="nav-button dynamic-text p-2 rounded-full hover:bg-gray-100 smooth-transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 id="current-month-year" class="text-2xl font-bold dynamic-text"></h2>
                    <button onclick="changeMonth(1)" class="nav-button dynamic-text p-2 rounded-full hover:bg-gray-100 smooth-transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-7 text-center font-bold text-gray-500 border-b pb-2">
                    <span>Пн</span><span>Вт</span><span>Ср</span><span>Чт</span><span>Пт</span><span class="text-red-500">Сб</span><span class="text-red-500">Вс</span>
                </div>
                
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">
                    <!-- Ячейки календаря будут сгенерированы JavaScript -->
                </div>
            </div>
            
            <!-- Краткая статистика за месяц -->
            <div id="monthly-summary" class="bg-white p-6 rounded-2xl shadow-xl smooth-transition">
                <h3 class="text-xl font-bold mb-3 dynamic-text">Статистика за месяц</h3>
                <div id="monthly-report-output" class="text-gray-700 space-y-2">
                    <!-- Здесь будет краткий отчет и средний балл -->
                    <p>Среднее настроение: <span id="monthly-average-mood" class="font-bold dynamic-text">Н/Д</span></p>
                    <p>Средний стресс: <span id="monthly-average-stress" class="font-bold dynamic-text">Н/Д</span></p>
                    <p>Записей сделано: <span id="monthly-count" class="font-bold dynamic-text">0</span></p>
                </div>
                <div id="monthly-report-ai-output" class="mt-4 pt-4 border-t border-gray-100 hidden">
                    <h4 class="font-semibold dynamic-text mb-2">Отчет от Gemini:</h4>
                    <div id="monthly-report-text" class="text-sm text-gray-600"></div>
                    <div id="report-ai-loading" class="text-center py-2 hidden">
                        <div class="animate-pulse text-gray-400">Загрузка отчета...</div>
                    </div>
                    <button onclick="getMonthlyReport()" class="mt-3 py-1 px-4 text-sm rounded-lg text-white font-semibold dynamic-bg hover:opacity-90 smooth-transition">
                        Сгенерировать Отчет
                    </button>
                </div>
            </div>
        </div>

        <!-- --- ВИД 3: АНАЛИТИКА --- -->
        <div id="view-charts" class="view-content hidden space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-xl smooth-transition">
                <h2 class="text-2xl font-bold mb-4 dynamic-text">График</h2>
                
                <!-- Панель выбора метрики -->
                <div class="flex justify-center space-x-3 mb-4 border-b pb-3">
                    <button class="chart-type-button active py-2 px-4 rounded-full text-sm dynamic-hover-bg dynamic-text font-semibold" data-type="mood" onclick="setChartType('mood')">Настроение</button>
                    <button class="chart-type-button py-2 px-4 rounded-full text-sm dynamic-hover-bg dynamic-text font-semibold" data-type="stress" onclick="setChartType('stress')">Стресс</button>
                </div>
                
                <!-- Панель выбора периода -->
                <div class="flex justify-center space-x-3 mb-6">
                    <button class="chart-period-button active py-2 px-4 rounded-full text-sm dynamic-bg-light dynamic-text font-semibold" data-period="week" onclick="setChartPeriod('week')">Неделя</button>
                    <button class="chart-period-button py-2 px-4 rounded-full text-sm dynamic-bg-light dynamic-text font-semibold" data-period="month" onclick="setChartPeriod('month')">Месяц</button>
                    <button class="chart-period-button py-2 px-4 rounded-full text-sm dynamic-bg-light dynamic-text font-semibold" data-period="year" onclick="setChartPeriod('year')">Год</button>
                </div>

                <div id="chart-date-display" class="text-center text-gray-500 mb-4"></div>
                
                <!-- Контейнер для графика -->
                <div id="mood-chart-container" class="relative">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- --- ВИД 4: НАСТРОЙКИ --- -->
        <div id="view-settings" class="view-content hidden space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-xl smooth-transition">
                <h2 class="text-2xl font-bold mb-4 dynamic-text">Настройки Приложения</h2>
                
                <!-- Настройки темы - ДОБАВЛЕНО БОЛЬШЕ ЦВЕТОВ -->
                <div class="mb-6 border p-4 rounded-xl dynamic-border border-opacity-30">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Тема (Цвет Акцента)</h3>
                    <div class="flex flex-wrap gap-4">
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #B39DDB;" data-theme="Lavender" onclick="setTheme('Lavender')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #80CBC4;" data-theme="Mint" onclick="setTheme('Mint')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #FFAB91;" data-theme="Peach" onclick="setTheme('Peach')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #A5D6A7;" data-theme="Sage" onclick="setTheme('Sage')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #90CAF9;" data-theme="Sky" onclick="setTheme('Sky')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #F48FB1;" data-theme="Pink" onclick="setTheme('Pink')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #FFCC80;" data-theme="Apricot" onclick="setTheme('Apricot')"></button>
                        <button class="theme-option w-10 h-10 rounded-full border-2 border-gray-300" style="background-color: #C5CAE9;" data-theme="Indigo" onclick="setTheme('Indigo')"></button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Текущий выбор темы сделан более мягким и пастельным.</p>
                </div>

                <!-- Настройки AI -->
                <div class="mb-6 border p-4 rounded-xl dynamic-border border-opacity-30">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Настройки Gemini AI</h3>
                    
                    <div class="space-y-4">
                        <!-- Ввод API Key -->
                        <div>
                            <label for="api-key-input" class="block text-gray-700 font-semibold mb-2">Ваш Gemini API Key</label>
                            <input type="password" id="api-key-input" class="w-full p-3 border rounded-xl focus:ring-2 dynamic-border focus:ring-purple-300 smooth-transition" placeholder="Введите ключ (не будет сохранен в коде!)">
                            <p class="text-xs text-gray-500 mt-1">Оставьте пустым для использования тестового API.</p>
                        </div>
                        
                        <!-- Выбор длины отчета -->
                        <div>
                            <label for="report-length-select" class="block text-gray-700 font-semibold mb-2">Длина Отчета</label>
                            <select id="report-length-select" class="w-full p-3 border rounded-xl focus:ring-2 dynamic-border focus:ring-purple-300 smooth-transition">
                                <option value="Short">Короткий (1-2 абзаца)</option>
                                <option value="Medium">Средний (3-4 абзаца)</option>
                                <option value="Long">Подробный (4-6 абзацев)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Кнопка сохранения настроек -->
                <button id="save-settings-button" onclick="saveSettings()" class="mt-6 w-full py-3 rounded-xl text-white font-bold text-lg dynamic-bg hover:opacity-90 smooth-transition shadow-lg">
                    Сохранить Настройки
                </button>
            </div>
        </div>
        
        <!-- Модальное окно для заметок (большое, с прокруткой) - Z-index z-60 -->
        <div id="notes-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-60 p-4 smooth-transition">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full h-4/5 flex flex-col dynamic-border smooth-transition" style="border-width: 2px;">
                <h3 class="text-xl font-bold mb-2 text-center dynamic-text">Все Записи за День</h3>
                <p id="notes-modal-date" class="text-center mb-4 text-gray-600 font-medium"></p>
                
                <div id="daily-notes-list" class="flex-grow overflow-y-auto pr-2 space-y-3">
                    <!-- Записи будут сгенерированы JavaScript -->
                </div>

                <button onclick="closeNotesModal()" class="mt-4 py-2 rounded-lg dynamic-bg text-white font-semibold hover:opacity-90 smooth-transition shadow-md">Закрыть</button>
            </div>
        </div>
        
        <!-- Модальное окно для подтверждения удаления -->
        <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4 smooth-transition">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full smooth-transition">
                <h3 class="text-lg font-bold mb-4 dynamic-text">Подтверждение Удаления</h3>
                <p id="confirm-modal-text" class="mb-6 text-gray-700"></p>
                <div class="flex justify-end space-x-4">
                    <button onclick="cancelAction()" class="py-2 px-4 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 smooth-transition">Отмена</button>
                    <button id="confirm-delete-button" class="py-2 px-4 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 smooth-transition">Удалить</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Скрипт для инициализации и работы с данными -->
    <script>
        // --- Глобальные переменные UI и Данных ---
        window.dailyLogs = []; 
        let dailyAverages = {}; 
        const STORAGE_KEY = 'dailyMoodLogs';
        const THEME_STORAGE_KEY = 'moodDiaryTheme';
        const GEMINI_API_KEY_STORAGE_KEY = 'userGeminiApiKey';
        const GEMINI_SETTINGS_STORAGE_KEY = 'geminiSettings';
        
        let userProvidedApiKey = ""; 
        let geminiSettings = {
            reportLength: 'Medium',
            model: 'gemini-2.5-flash-preview-09-2025'
        };

        let currentMood = 3; 
        let currentStress = 3; 
        let currentMonth = new Date().getMonth(); 
        let currentYear = new Date().getFullYear(); 
        let currentChartPeriod = 'week';
        let currentChartType = 'mood'; 
        
        let mainChartInstance = null;
        let audioContext = null;
        let synth = null;
        
        const MOOD_LABELS = {
            1: "Ужасно", 2: "Плохо", 3: "Нормально", 4: "Хорошо", 5: "Великолепно"
        };
        const STRESS_LABELS = { 
            1: "Низкий", 2: "Спокойный", 3: "Умеренный", 4: "Высокий", 5: "Критический"
        };
        const MONTH_NAMES = [
            "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
            "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
        ];
        
        // НОВЫЕ, БОЛЕЕ НЕЖНЫЕ ТЕМЫ!
        const THEMES = {
            'Lavender': { 
                '--p-text': '#585098', 
                '--p-accent': '#B39DDB',       
                '--p-accent-light': '#EFE7FC' 
            },
            'Mint': { 
                '--p-text': '#00695C', 
                '--p-accent': '#80CBC4',       
                '--p-accent-light': '#E0F2F1'
            },
            'Peach': { 
                '--p-text': '#D84315', 
                '--p-accent': '#FFAB91',       
                '--p-accent-light': '#FBE9E7'
            },
            'Sage': { 
                '--p-text': '#2E7D32', 
                '--p-accent': '#A5D6A7',       
                '--p-accent-light': '#E8F5E9'
            },
            // --- НОВЫЕ ТЕМЫ ---
            'Sky': { 
                '--p-text': '#1565C0', 
                '--p-accent': '#90CAF9',       
                '--p-accent-light': '#E3F2FD'
            },
            'Pink': { 
                '--p-text': '#C2185B', 
                '--p-accent': '#F48FB1',       
                '--p-accent-light': '#FCE4EC'
            },
            'Apricot': { 
                '--p-text': '#E65100', 
                '--p-accent': '#FFCC80',       
                '--p-accent-light': '#FFF3E0'
            },
            'Indigo': { 
                '--p-text': '#303F9F', 
                '--p-accent': '#C5CAE9',       
                '--p-accent-light': '#E8EAF6'
            }
        };


        // --- Утилиты ---
        
        /** Инициализирует Tone.js (аудио) */
        function initAudio() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            if (!synth) {
                synth = new Tone.Synth().toDestination();
            }
        }

        /** Воспроизводит тихий звук "клика" */
        function playClickSound() {
            initAudio();
            synth.triggerAttackRelease("C4", "32n", Tone.now(), 0.1); 
        }
        
        /** * Простой конвертер Markdown в HTML для базового форматирования.
         * Поддерживает **жирный**, списки (* или -), и абзацы.
         */
        function markdownToHtml(markdown) {
            // 1. Замена жирного текста: **текст** или __текст__
            let html = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');

            // 2. Обработка списков (* или - в начале строки)
            // Ищем блоки списков (строки, начинающиеся с * или -)
            const listRegex = /(\n|^)([*-]\s[^\n]+)+/g;
            html = html.replace(listRegex, (match) => {
                let listItems = match.trim().split('\n').map(line => {
                    // Удаляем * или - и пробел
                    const content = line.trim().substring(2).trim();
                    return `<li>${content}</li>`;
                }).join('');
                return `<ul>${listItems}</ul>`;
            });

            // 3. Замена двойных переносов строк на абзацы (<p>). 
            // Это разбивает текст на абзацы, сохраняя одиночные переносы как <br>
            html = html.split('\n\n').map(paragraph => {
                if (paragraph.trim() === '') {
                    return '';
                }
                // Не оборачиваем списки в <p>
                if (paragraph.trim().startsWith('<ul>')) {
                    return paragraph;
                }
                // Заменяем одиночные переносы строки на <br> внутри абзацев
                let content = paragraph.trim().replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');

            return html;
        }


        /** Устанавливает цветовую тему */
        function setTheme(themeName) {
            const theme = THEMES[themeName] || THEMES['Lavender'];
            const root = document.documentElement;
            
            for (const [key, value] of Object.entries(theme)) {
                root.style.setProperty(key, value);
            }
            localStorage.setItem(THEME_STORAGE_KEY, themeName);
            
            // Обновляем круги в настройках
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('border-4', 'border-black');
            });
            // Убедимся, что выбранная кнопка существует, прежде чем добавлять класс
            const selectedBtn = document.querySelector(`.theme-option[data-theme="${themeName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('border-4', 'border-black');
            }
            
            if (mainChartInstance) {
                updateChartColors();
            }
        }

        /** Загрузка настроек при старте */
        function loadSettings() {
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'Lavender'; // Default to softer Lavender
            setTheme(savedTheme);
            
            const savedApiKey = localStorage.getItem(GEMINI_API_KEY_STORAGE_KEY);
            if (savedApiKey) {
                userProvidedApiKey = savedApiKey;
            }
            
            const savedSettings = localStorage.getItem(GEMINI_SETTINGS_STORAGE_KEY);
            if (savedSettings) {
                geminiSettings = JSON.parse(savedSettings);
            }
            
            // Установка значений в форме настроек
            document.getElementById('api-key-input').value = userProvidedApiKey ? '***API KEY SET***' : '';
            document.getElementById('report-length-select').value = geminiSettings.reportLength;
        }

        /** Сохранение настроек из формы */
        function saveSettings() {
            playClickSound();
            const apiKeyInput = document.getElementById('api-key-input').value.trim();
            const reportLength = document.getElementById('report-length-select').value;
            
            if (apiKeyInput && apiKeyInput !== '***API KEY SET***') {
                userProvidedApiKey = apiKeyInput;
                localStorage.setItem(GEMINI_API_KEY_STORAGE_KEY, userProvidedApiKey);
            } else if (apiKeyInput === '') {
                userProvidedApiKey = '';
                localStorage.removeItem(GEMINI_API_KEY_STORAGE_KEY);
            }
            
            geminiSettings.reportLength = reportLength;
            localStorage.setItem(GEMINI_SETTINGS_STORAGE_KEY, JSON.stringify(geminiSettings));
            
            showMessage('Настройки сохранены!', 'bg-green-100 text-green-800');
        }

        /** Загрузка данных из LocalStorage */
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                dailyLogs = JSON.parse(data);
                // Заполняем stress: 3 для старых записей, чтобы избежать NaN
                dailyLogs.forEach(log => {
                    if (log.stress === undefined) {
                        log.stress = 3;
                    }
                });
            } else {
                dailyLogs = [];
            }
            processDailyAverages();
        }

        /** Сохранение данных в LocalStorage */
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dailyLogs));
        }

        /** Обработка средних значений настроения и стресса по дням */
        function processDailyAverages() {
            const dailyData = dailyLogs.reduce((acc, log) => {
                const dateKey = log.date;
                if (!acc[dateKey]) {
                    acc[dateKey] = { totalMood: 0, count: 0, totalStress: 0 }; 
                }
                acc[dateKey].totalMood += log.mood;
                acc[dateKey].totalStress += (log.stress || 3); // Защита от старых данных
                acc[dateKey].count++;
                return acc;
            }, {});

            dailyAverages = {};
            for (const dateKey in dailyData) {
                dailyAverages[dateKey] = {
                    avgMood: dailyData[dateKey].totalMood / dailyData[dateKey].count,
                    avgStress: dailyData[dateKey].totalStress / dailyData[dateKey].count,
                    count: dailyData[dateKey].count
                };
            }
        }
        
        /** Форматирование даты в YYYY-MM-DD */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        /** Форматирование даты в читаемый вид */
        function formatReadableDate(dateKey) {
            if (!dateKey) return '';
            const parts = dateKey.split('-');
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            return `${date.getDate()} ${MONTH_NAMES[date.getMonth()]} ${date.getFullYear()} г.`;
        }

        /** Отображение сообщения */
        function showMessage(text, classes) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = `mt-4 text-center p-3 rounded-lg ${classes} smooth-transition`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 3000);
        }

        // --- Логика UI ---

        /** Переключение вкладок */
        function switchView(viewId) {
            playClickSound();
            
            // Анимация: скрываем и показываем
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.remove('active-view');
                view.classList.add('hidden');
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-view="${viewId}"]`).classList.add('active');

            const nextView = document.getElementById(`view-${viewId}`);
            nextView.classList.remove('hidden');
            setTimeout(() => {
                nextView.classList.add('active-view'); 
            }, 10); 

            if (viewId === 'calendar') {
                renderCalendar();
            } else if (viewId === 'charts') {
                processDailyAverages();
                updateCharts();
            } else if (viewId === 'input') {
                 // Установка текущей даты при переключении
                document.getElementById('log-date').value = formatDate(new Date()); 
            }
        }

        /** Выбор настроения */
        function selectMood(mood) {
            playClickSound();
            currentMood = mood;
            document.querySelectorAll('.rating-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.rating-option[data-mood="${mood}"]`).classList.add('selected');
            document.getElementById('mood-label').textContent = MOOD_LABELS[mood];
        }

        /** Выбор стресса */
        function selectStress(stress) {
            playClickSound();
            currentStress = stress;
            document.querySelectorAll('.stress-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.stress-option[data-stress="${stress}"]`).classList.add('selected');
            document.getElementById('stress-label').textContent = STRESS_LABELS[stress];
        }

        /** Сохранение записи */
        function saveLog() {
            playClickSound();
            const notes = document.getElementById('mood-notes').value.trim();
            const dateInput = document.getElementById('log-date').value; 
            
            if (notes.length < 5) {
                showMessage('Пожалуйста, добавьте более подробное описание (минимум 5 символов).', 'bg-red-100 text-red-800');
                return;
            }

            let logDate = new Date();
            if (dateInput) {
                const parts = dateInput.split('-');
                logDate = new Date(parts[0], parts[1] - 1, parts[2]); 
            }
            
            const dateKey = formatDate(logDate);
            const now = new Date();
            const timeKey = now.toTimeString().split(' ')[0].substring(0, 5); 

            const newLog = {
                id: Date.now(),
                date: dateKey,
                time: timeKey,
                mood: currentMood,
                stress: currentStress, 
                notes: notes,
                timestamp: now.getTime()
            };

            dailyLogs.push(newLog);
            saveData();
            processDailyAverages();
            
            showMessage(`Запись за ${dateKey} успешно сохранена!`, 'bg-blue-100 text-blue-800');
            
            // Очистка формы
            document.getElementById('mood-notes').value = '';
            document.getElementById('log-date').value = formatDate(new Date()); 
            selectMood(3); 
            selectStress(3); 
            
            generateAnalysis(newLog);
        }
        
        /** Открытие модального окна заметок */
        function openNotesModal(dateKey) {
            playClickSound();
            const logsForDay = dailyLogs.filter(log => log.date === dateKey)
                                        .sort((a, b) => b.timestamp - a.timestamp); 
            
            document.getElementById('notes-modal-date').textContent = formatReadableDate(dateKey);
            const list = document.getElementById('daily-notes-list');
            list.innerHTML = '';

            logsForDay.forEach(log => {
                const moodLabel = MOOD_LABELS[log.mood];
                const stressLabel = STRESS_LABELS[log.stress || 3];
                const noteElement = document.createElement('div');
                
                noteElement.className = 'bg-white p-4 rounded-xl shadow-md border border-gray-100 smooth-transition';
                noteElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2 border-b pb-1">
                        <div>
                            <span class="text-sm font-bold dynamic-text block">Настроение: ${moodLabel} (${log.mood}/5)</span>
                            <span class="text-xs font-semibold text-gray-600 block">Стресс: ${stressLabel} (${log.stress || 3}/5)</span>
                        </div>
                        <span class="text-xs text-gray-500">${log.time}</span>
                    </div>
                    <!-- Контейнер для текста заметки с ограничением по высоте -->
                    <div id="note-text-${log.id}" class="note-content text-gray-700 text-sm overflow-hidden smooth-transition" style="max-height: 80px;">
                        <p class="mb-0">${log.notes}</p>
                    </div>
                    <!-- Кнопка "Показать полностью" -->
                    <button data-id="${log.id}" onclick="toggleNoteExpansion(${log.id})" class="show-more-btn mt-1 text-xs text-gray-500 hover:text-gray-700 smooth-transition font-semibold">
                        ... Показать полностью
                    </button>
                    <!-- Кнопка удаления -->
                    <button data-id="${log.id}" onclick="showConfirmDelete(this, '${dateKey}')" class="mt-2 text-xs text-red-500 hover:text-red-700 smooth-transition block">
                        Удалить Запись
                    </button>
                `;
                list.appendChild(noteElement);
                
                // Проверяем, нужно ли показывать кнопку "Показать полностью"
                // Если высота скролла больше, чем установленный max-height, показываем кнопку
                const contentDiv = document.getElementById(`note-text-${log.id}`);
                const showMoreBtn = contentDiv.nextElementSibling;
                if (contentDiv.scrollHeight <= 80) {
                    showMoreBtn.classList.add('hidden');
                }
            });

            document.getElementById('notes-modal').classList.remove('hidden', 'opacity-0');
            document.getElementById('notes-modal').classList.add('flex', 'opacity-100');
        }
        
        /** Раскрывает или сворачивает текст заметки. */
        function toggleNoteExpansion(logId) {
            playClickSound();
            const content = document.getElementById(`note-text-${logId}`);
            const button = content.nextElementSibling; 
            
            if (content.style.maxHeight === '80px') {
                content.style.maxHeight = content.scrollHeight + 'px';
                button.textContent = '... Свернуть';
            } else {
                content.style.maxHeight = '80px';
                button.textContent = '... Показать полностью';
            }
        }
        
        /** Закрытие модального окна заметок */
        function closeNotesModal() {
            playClickSound();
            document.getElementById('notes-modal').classList.add('hidden', 'opacity-0');
            document.getElementById('notes-modal').classList.remove('flex', 'opacity-100');
            renderCalendar(); 
        }

        /** Показ модального окна подтверждения удаления */
        function showConfirmDelete(button, dateKey) {
            const logId = parseInt(button.getAttribute('data-id'));
            const log = dailyLogs.find(l => l.id === logId);

            if (!log) return;

            document.getElementById('confirm-modal-text').textContent = 
                `Вы уверены, что хотите удалить запись (Настроение: ${log.mood}/5, Стресс: ${log.stress || 3}/5) за ${log.date} ${log.time}?`;

            const confirmButton = document.getElementById('confirm-delete-button');
            confirmButton.onclick = () => deleteLog(logId, dateKey);

            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        /** Отмена действия (закрытие модального окна подтверждения) */
        function cancelAction() {
            playClickSound();
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        /** Удаление записи */
        function deleteLog(logId, dateKey) {
            playClickSound();
            dailyLogs = dailyLogs.filter(log => log.id !== logId);
            saveData();
            processDailyAverages();
            
            document.getElementById('confirm-modal').classList.add('hidden');

            if (dailyLogs.filter(log => log.date === dateKey).length > 0) {
                openNotesModal(dateKey); // Повторное открытие для обновления списка
            } else {
                closeNotesModal(); 
                renderCalendar();
            }
        }
        
        // --- Логика Календаря ---

        /** Рендеринг календаря */
        function renderCalendar() {
            document.getElementById('current-month-year').textContent = 
                `${MONTH_NAMES[currentMonth]} ${currentYear}`;
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            let startDay = firstDayOfMonth.getDay(); 
            startDay = startDay === 0 ? 6 : startDay - 1;
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const todayKey = formatDate(new Date());

            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell text-gray-400';
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateKey = formatDate(date);
                const avgData = dailyAverages[dateKey];
                
                const cell = document.createElement('div');
                cell.textContent = day;
                cell.className = 'day-cell smooth-transition';
                cell.setAttribute('data-date', dateKey);

                if (avgData !== undefined) {
                    cell.onclick = () => openNotesModal(dateKey);

                    // Цветовая индикация на основе СРЕДНЕГО НАСТРОЕНИЯ
                    const color = getColorForMood(avgData.avgMood);
                    cell.style.backgroundColor = color.light;
                    cell.style.color = color.dark;
                    cell.style.fontWeight = '700';
                    cell.classList.add('has-data');
                    
                    // Добавляем средний балл как всплывающую подсказку
                    cell.setAttribute('title', 
                        `Настроение: ${avgData.avgMood.toFixed(1)}/5\nСтресс: ${avgData.avgStress.toFixed(1)}/5`);
                } else {
                    cell.classList.add('bg-white', 'text-gray-700', 'cursor-default');
                    cell.onclick = () => showMessage('Нет записей за этот день.', 'bg-yellow-100 text-yellow-800');
                }
                
                if (dateKey === todayKey) {
                    cell.classList.add('is-today');
                }


                calendarGrid.appendChild(cell);
            }
            renderMonthlyReport();
        }

        /** Смена месяца */
        function changeMonth(direction) {
            playClickSound();
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        /** Получение цвета в зависимости от НАСТРОЕНИЯ */
        function getColorForMood(mood) {
            // Используем мягкие, нежные цвета
            if (mood >= 4.5) return { light: '#C8E6C9', dark: '#2E7D32' }; // Green (Sage-like)
            if (mood >= 3.5) return { light: '#FFFDE7', dark: '#F9A825' }; // Light Yellow
            if (mood >= 2.5) return { light: '#EFE7FC', dark: '#585098' }; // Lavender (Neutral/Theme)
            if (mood >= 1.5) return { light: '#FBE9E7', dark: '#D84315' }; // Peach (Orange)
            return { light: '#FFCDD2', dark: '#C62828' }; // Soft Red
        }

        /** Рендеринг отчета за месяц */
        function renderMonthlyReport() {
            const logsInMonth = dailyLogs.filter(log => {
                const date = new Date(log.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const count = logsInMonth.length;
            
            let averageMood = 'Н/Д';
            let averageStress = 'Н/Д';

            if (count > 0) {
                const totalMood = logsInMonth.reduce((sum, log) => sum + log.mood, 0);
                const totalStress = logsInMonth.reduce((sum, log) => sum + (log.stress || 3), 0);

                averageMood = (totalMood / count).toFixed(2);
                averageStress = (totalStress / count).toFixed(2);
            }


            document.getElementById('monthly-average-mood').textContent = averageMood;
            document.getElementById('monthly-average-stress').textContent = averageStress;
            document.getElementById('monthly-count').textContent = count;

            const reportOutput = document.getElementById('monthly-report-ai-output');
            if (count > 0) {
                reportOutput.classList.remove('hidden');
            } else {
                reportOutput.classList.add('hidden');
                document.getElementById('monthly-report-text').innerHTML = '';
            }
        }
        
        // --- Логика Графиков (Chart.js) ---
        
        /** Установка типа графика (mood/stress) */
        function setChartType(type) {
            playClickSound();
            currentChartType = type;
            document.querySelectorAll('.chart-type-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.chart-type-button[data-type="${type}"]`).classList.add('active');
            updateCharts();
        }


        /** Инициализация или обновление графика */
        function updateCharts() {
            processChartData();
            if (mainChartInstance) {
                mainChartInstance.destroy();
            }
            renderChart();
        }

        /** Установка периода графика */
        function setChartPeriod(period) {
            playClickSound();
            currentChartPeriod = period;
            document.querySelectorAll('.chart-period-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.chart-period-button[data-period="${period}"]`).classList.add('active');
            updateCharts();
        }

        /** Подготовка данных для графика */
        function processChartData() {
            let labels = [];
            let data = [];
            let dateDisplay = '';

            const today = new Date();
            let startDate, endDate;

            // Определяем начальную и конечную дату
            if (currentChartPeriod === 'week') {
                endDate = today;
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 6);
                dateDisplay = `Последние 7 дней (до ${formatDate(today)})`;
            } else if (currentChartPeriod === 'month') {
                endDate = today;
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 29);
                dateDisplay = `Последние 30 дней (до ${formatDate(today)})`;
            } else if (currentChartPeriod === 'year') {
                endDate = today;
                startDate = new Date(today);
                startDate.setFullYear(today.getFullYear() - 1);
                dateDisplay = `Последние 365 дней`;
            }

            document.getElementById('chart-date-display').textContent = dateDisplay;

            // Собираем данные
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = formatDate(d);
                labels.push(d.getDate() + '.' + String(d.getMonth() + 1).padStart(2, '0'));
                
                const avgData = dailyAverages[dateKey];
                let value = null;
                
                if (avgData) {
                    value = currentChartType === 'mood' ? avgData.avgMood : avgData.avgStress;
                }
                
                data.push(value);
            }

            currentChartData = { labels, data };
        }

        /** Обновление цветов графика в соответствии с темой */
        function updateChartColors() {
            const rootStyle = getComputedStyle(document.documentElement);
            const accent = rootStyle.getPropertyValue('--p-accent').trim();
            const accentLight = rootStyle.getPropertyValue('--p-accent-light').trim();
            const text = rootStyle.getPropertyValue('--p-text').trim();

            if (mainChartInstance) {
                mainChartInstance.data.datasets[0].borderColor = accent;
                mainChartInstance.data.datasets[0].backgroundColor = accentLight;
                mainChartInstance.options.scales.y.ticks.color = text;
                mainChartInstance.options.scales.x.ticks.color = text;
                mainChartInstance.update();
            }
        }
        
        /** Рендеринг графика настроения/стресса */
        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const rootStyle = getComputedStyle(document.documentElement);
            const accent = rootStyle.getPropertyValue('--p-accent').trim();
            const accentLight = rootStyle.getPropertyValue('--p-accent-light').trim();
            const text = rootStyle.getPropertyValue('--p-text').trim();
            
            const chartLabel = currentChartType === 'mood' ? 'Среднее Настроение' : 'Средний Стресс';

            mainChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentChartData.labels,
                    datasets: [{
                        label: chartLabel,
                        data: currentChartData.data,
                        fill: true,
                        borderColor: accent,
                        backgroundColor: accentLight,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: accent,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                color: text,
                                font: { weight: 'bold' }
                            },
                            title: {
                                display: true,
                                text: chartLabel,
                                color: text
                            },
                            grid: {
                                color: accentLight,
                                borderDash: [5, 5]
                            }
                        },
                        x: {
                            ticks: {
                                color: text
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${chartLabel}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Gemini AI Логика ---
        
        /**
         * Управляет вызовом Gemini API для генерации отчета.
         */
        async function generateAnalysis(log) {
            const container = document.getElementById('ai-analysis-container');
            const output = document.getElementById('ai-analysis-output');
            const loading = document.getElementById('ai-loading');
            const citationContainer = document.getElementById('ai-citation-container');
            const citationList = document.getElementById('ai-citation-list');

            output.innerHTML = '';
            citationList.innerHTML = '';
            citationContainer.classList.add('hidden');
            container.classList.remove('hidden');
            loading.classList.remove('hidden');

            const systemPrompt = `Ты - продвинутый психолог и аналитик данных. Твоя задача - проанализировать одну запись из дневника настроения пользователя. 
            Предоставь краткий и эмпатичный анализ, основанный на: 
            1. Оценке настроения (от 1 до 5).
            2. Оценке стресса (от 1 до 5).
            3. Описании событий дня.
            ${geminiSettings.reportLength === 'Short' ? 'Ответ должен быть в одном-двух абзацах.' : 
              geminiSettings.reportLength === 'Medium' ? 'Ответ должен быть в 3-4 абзацах.' : 
              'Ответ должен быть подробным (4-6 абзацев).'}
            Обязательно дай совет или предложи небольшую практику, основанную на записи, учитывая баланс настроения и стресса.
            Используй только предоставленную информацию, не ищи внешние данные.`;

            const userQuery = `Анализ записи:
            Дата/Время: ${log.date} ${log.time}
            Оценка настроения: ${log.mood}/5 (${MOOD_LABELS[log.mood]})
            Оценка стресса: ${log.stress || 3}/5 (${STRESS_LABELS[log.stress || 3]})
            Описание дня: "${log.notes}"`;
            
            await callGeminiApi(systemPrompt, userQuery, output, citationList, citationContainer);
            loading.classList.add('hidden');
        }

        /**
         * Генерирует и отображает ежемесячный отчет.
         */
        async function getMonthlyReport() {
            const logsInMonth = dailyLogs.filter(log => {
                const date = new Date(log.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).sort((a, b) => a.timestamp - b.timestamp); 

            if (logsInMonth.length === 0) return;

            const dateRange = `${MONTH_NAMES[currentMonth]} ${currentYear} г.`;
            const logsText = logsInMonth.map(log => 
                `* [${log.date.substring(5)}] Настроение ${log.mood}/5, Стресс ${log.stress || 3}/5: ${log.notes}`
            ).join('\n');
            
            const systemPrompt = `Ты - продвинутый психолог и аналитик данных. Твоя задача - проанализировать данные дневника настроения и стресса за месяц.
            Предоставь всесторонний отчет, который включает:
            1. Общая тенденция настроения и стресса (баланс, колебания, корреляция).
            2. Выявление общих тем, которые коррелируют с высоким/низким настроением И высоким/низким стрессом.
            3. Заключительный вывод и общие рекомендации для следующего месяца.
            ${geminiSettings.reportLength === 'Short' ? 'Отчет должен быть кратким (1-2 абзаца).' : 
              geminiSettings.reportLength === 'Medium' ? 'Отчет должен быть средним (3-4 абзаца).' : 
              'Отчет должен быть подробным (4-6 абзацев).'}
            Используй только предоставленные данные. Форматируй ответ с использованием Markdown (заголовки, жирный текст, списки).`;

            const userQuery = `Проанализируй следующие записи за период ${dateRange}:\n\n${logsText}`;

            const reportOutput = document.getElementById('monthly-report-text');
            const loading = document.getElementById('report-ai-loading');
            
            reportOutput.innerHTML = '';
            loading.classList.add('hidden');

            await callGeminiApi(systemPrompt, userQuery, reportOutput, null, null);
            loading.classList.add('hidden');
        }


        /**
         * Вызов API Gemini с экспоненциальным отступлением.
         */
        async function callGeminiApi(systemPrompt, userQuery, outputElement, citationList, citationContainer) {
            const apiKey = userProvidedApiKey;
            const model = geminiSettings.model;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const MAX_RETRIES = 5;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        
                        // ПРИМЕНЕНИЕ MARKDOWN К ТЕКСТУ ОТЧЕТА
                        const formattedText = markdownToHtml(text);
                        outputElement.innerHTML = formattedText;
                        
                        if (citationList && citationContainer) {
                            let sources = [];
                            const groundingMetadata = candidate.groundingMetadata;
                            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions.map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                })).filter(source => source.uri && source.title);
                            }

                            if (sources.length > 0) {
                                citationList.innerHTML = sources.map(s => 
                                    `<li><a href="${s.uri}" target="_blank" class="text-purple-600 hover:underline">${s.title}</a></li>`
                                ).join('');
                                citationContainer.classList.remove('hidden');
                            }
                        }
                        return;

                    } else {
                        throw new Error("Не удалось получить текст от Gemini AI.");
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    outputElement.textContent = `Ошибка: Не удалось получить анализ. Проверьте ваш API Key и лимиты. (${error.message})`;
                    return;
                }
            }
        }


        // --- Инициализация Приложения ---

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadData();
            
            selectMood(currentMood);
            selectStress(currentStress); 
            
            // Установка текущей даты в поле ввода при старте
            document.getElementById('log-date').value = formatDate(new Date());

            // Первичное отображение
            const initialView = document.querySelector('.view-content.active-view');
            if (initialView) {
                setTimeout(() => {
                    initialView.classList.add('active-view');
                }, 10);
            }
        });
    </script>
</body>
</html>

