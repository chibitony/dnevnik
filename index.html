<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой Дневник Настроения</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN для графиков -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Tone.js CDN для звуковой обратной связи (тихий "клик") -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <!-- Lucide Icons для красивых иконок -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Цветовая схема по умолчанию (Лаванда) - Светлая */
        :root {
            --p-bg: #F8FAFF; 
            --p-text: #334155; /* Slate-700 */
            --p-text-muted: #64748b; /* Slate-500 */
            --p-accent: #8B5CF6; /* Violet-500 */
            --p-accent-light: #EDE9FE; /* Violet-100 */
            --p-bg-card: #FFFFFF;
            --p-border: #e2e8f0;
            --p-shadow: rgba(0, 0, 0, 0.1);
        }

        /* Темная тема */
        body.dark-mode {
            --p-bg: #0f172a; /* Slate-900 */
            --p-text: #f1f5f9; /* Slate-100 */
            --p-text-muted: #94a3b8; /* Slate-400 */
            --p-accent: #a78bfa; /* Violet-400 */
            --p-accent-light: #1e293b; /* Slate-800 */
            --p-bg-card: #1e293b; /* Slate-800 */
            --p-border: #334155; /* Slate-700 */
            --p-shadow: rgba(0, 0, 0, 0.3);
        }

        /* Универсальный класс для плавных переходов */
        .smooth-transition { 
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Настройка шрифта и фона */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--p-bg);
            color: var(--p-text);
        }

        .card-bg {
            background-color: var(--p-bg-card);
            border: 1px solid var(--p-border);
        }

        /* Визуальное оформление активного состояния кнопок (для кружков и вкладок) */
        .mood-btn.active, .stress-btn.active {
            transform: scale(1.1);
            filter: brightness(1.1);
        }
        
        .stress-btn.active {
             box-shadow: 0 0 0 4px var(--p-accent-light), 0 0 0 6px var(--p-accent);
        }

        /* Скрытая прокрутка для боковой панели */
        #logs-list {
            scrollbar-width: none; /* Firefox */
        }
        #logs-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Плавное появление вкладок */
        .view-content {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .view-content.active-view {
            display: block;
            opacity: 1;
        }

        /* Увеличенная высота графика */
        .chart-container {
            height: 350px; 
            width: 100%;
        }

        /* Стилизация Markdown для окна анализа */
        #analysis-output h2 {
            font-size: 1.5rem; 
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--p-accent);
            border-bottom: 2px solid var(--p-accent-light);
            padding-bottom: 0.25rem;
        }
        #analysis-output h3 {
            font-size: 1.25rem; 
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--p-text);
        }
        #analysis-output p { margin-bottom: 1rem; line-height: 1.6; }
        #analysis-output ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        #analysis-output li { margin-bottom: 0.5rem; }

        /* Стилизация Таблиц в Markdown */
        #analysis-output table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            box-shadow: 0 1px 3px var(--p-shadow);
        }
        #analysis-output th, #analysis-output td {
            border: 1px solid var(--p-border);
            padding: 0.75rem;
            text-align: left;
        }
        #analysis-output th {
            background-color: var(--p-accent-light);
            color: var(--p-text);
            font-weight: 600;
        }
        #analysis-output tr:nth-child(even) {
            background-color: var(--p-bg);
        }
        
        /* Стили для календарных дней */
        .calendar-day-cell {
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }
        .calendar-day-cell:hover {
            opacity: 0.85;
            transform: translateY(-2px);
        }

        /* Инпуты в темной теме */
        body.dark-mode input, 
        body.dark-mode textarea, 
        body.dark-mode select {
            background-color: #0f172a;
            color: #f1f5f9;
            border-color: #334155;
        }
        
        /* Кнопка переключения темы */
        .theme-toggle-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
        }
        
        /* Линейка настроения */
        .mood-scale-segment {
            height: 8px;
            transition: background-color 0.3s;
        }

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen smooth-transition">

    <!-- Кнопка быстрой смены темы -->
    <button id="global-theme-toggle" class="theme-toggle-btn p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg border border-gray-200 dark:border-slate-700 text-gray-700 dark:text-gray-200 hover:scale-110 smooth-transition">
        <i data-lucide="moon" class="block dark:hidden"></i>
        <i data-lucide="sun" class="hidden dark:block"></i>
    </button>

    <div id="app-container" class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold" style="color: var(--p-text)">
                Дневник Настроения <span style="color: var(--p-accent)">v3.5</span>
            </h1>
            <p class="mt-1" style="color: var(--p-text-muted)">Отслеживание, анализ и управление своим эмоциональным состоянием.</p>
        </header>

        <!-- Меню Вкладок -->
        <nav class="flex justify-center mb-8 p-1 card-bg rounded-xl shadow-lg smooth-transition">
            <button class="tab-btn flex-1 py-3 px-4 text-center text-sm font-semibold rounded-lg smooth-transition hover:bg-gray-100 dark:hover:bg-slate-700" style="color: var(--p-text)" data-target="log-entry">
                Запись
            </button>
            <button class="tab-btn flex-1 py-3 px-4 text-center text-sm font-semibold rounded-lg smooth-transition hover:bg-gray-100 dark:hover:bg-slate-700" style="color: var(--p-text)" data-target="logs">
                Журнал
            </button>
            <button class="tab-btn flex-1 py-3 px-4 text-center text-sm font-semibold rounded-lg smooth-transition hover:bg-gray-100 dark:hover:bg-slate-700" style="color: var(--p-text)" data-target="analysis">
                Анализ ИИ
            </button>
            <button class="tab-btn flex-1 py-3 px-4 text-center text-sm font-semibold rounded-lg smooth-transition hover:bg-gray-100 dark:hover:bg-slate-700" style="color: var(--p-text)" data-target="settings">
                Настройки
            </button>
        </nav>

        <!-- 1. Вкладка "Запись" -->
        <div id="log-entry" class="view-content">
            <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)" id="entry-title">Ежедневная Запись</h2>

                <!-- Дата и Время -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="log-date" class="block text-sm font-medium mb-1" style="color: var(--p-text-muted)">Дата:</label>
                        <input type="date" id="log-date" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-500 smooth-transition outline-none">
                    </div>
                    <div>
                        <label for="log-time" class="block text-sm font-medium mb-1" style="color: var(--p-text-muted)">Время:</label>
                        <input type="time" id="log-time" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-500 smooth-transition outline-none">
                    </div>
                </div>

                <!-- Выбор Настроения (Кнопки генерируются JS для кастомных цветов) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2" style="color: var(--p-text-muted)">Мое Настроение (1 - 5):</label>
                    <div id="mood-selector" class="flex justify-between space-x-2 sm:space-x-4">
                        <!-- Кнопки будут вставлены через JS -->
                    </div>
                     <!-- Новая Линейка Настроения -->
                    <div id="mood-scale-visualizer" class="flex mt-4 rounded-full overflow-hidden">
                        <div class="mood-scale-segment w-1/5 rounded-l-full" data-mood="1"></div>
                        <div class="mood-scale-segment w-1/5" data-mood="2"></div>
                        <div class="mood-scale-segment w-1/5" data-mood="3"></div>
                        <div class="mood-scale-segment w-1/5" data-mood="4"></div>
                        <div class="mood-scale-segment w-1/5 rounded-r-full" data-mood="5"></div>
                    </div>
                    <div class="flex justify-between text-xs mt-1" style="color: var(--p-text-muted)">
                        <span>Ужасно</span>
                        <span>Отлично</span>
                    </div>
                </div>

                <!-- Выбор Уровня Стресса -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2" style="color: var(--p-text-muted)">Уровень Стресса (1 - 5):</label>
                    <div id="stress-selector" class="flex justify-between space-x-2 sm:space-x-4">
                        <button data-stress="1" class="stress-btn flex flex-col items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full aspect-square bg-cyan-100 text-cyan-700 hover:bg-cyan-200 smooth-transition" title="Очень низкий">1</button>
                        <button data-stress="2" class="stress-btn flex flex-col items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full aspect-square bg-teal-100 text-teal-700 hover:bg-teal-200 smooth-transition" title="Низкий">2</button>
                        <button data-stress="3" class="stress-btn flex flex-col items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full aspect-square bg-amber-100 text-amber-700 hover:bg-amber-200 smooth-transition" title="Средний">3</button>
                        <button data-stress="4" class="stress-btn flex flex-col items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full aspect-square bg-red-200 text-red-800 hover:bg-red-300 smooth-transition" title="Высокий">4</button>
                        <button data-stress="5" class="stress-btn flex flex-col items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full aspect-square bg-red-400 text-white hover:bg-red-500 smooth-transition" title="Критический">5</button>
                    </div>
                </div>

                <!-- Поле для Заметки -->
                <div class="mb-6">
                    <label for="log-note" class="block text-sm font-medium mb-1" style="color: var(--p-text-muted)">Заметка дня:</label>
                    <textarea id="log-note" rows="4" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-500 smooth-transition outline-none" placeholder="Что произошло сегодня?"></textarea>
                </div>

                <div class="flex space-x-4">
                    <button id="save-log-btn" class="flex-1 bg-violet-600 text-white font-semibold py-3 rounded-lg hover:bg-violet-700 smooth-transition shadow-md hover:shadow-lg">
                        Сохранить Запись
                    </button>
                    <button id="cancel-edit-btn" class="hidden px-6 bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-300 smooth-transition shadow-md hover:shadow-lg">
                        Отмена
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Вкладка "Журнал" -->
        <div id="logs" class="view-content">
            <div class="space-y-8">
                
                <!-- Календарь -->
                <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Календарь Настроения</h2>
                    <div id="calendar-container" class="space-y-4">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="nav-btn px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 smooth-transition text-sm" style="color: var(--p-text)">&#9664;</button>
                            <span id="current-calendar-month" class="text-lg font-semibold" style="color: var(--p-text)"></span>
                            <button id="next-month-btn" class="nav-btn px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 smooth-transition text-sm" style="color: var(--p-text)">&#9654;</button>
                        </div>
                        <div id="calendar-grid"></div>
                    </div>
                </div>

                <!-- Сводка Периода (НОВАЯ ФУНКЦИЯ) -->
                <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Сводка Периода</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-2 sm:space-y-0">
                        <div id="time-nav-container" class="flex space-x-2 w-full sm:w-auto">
                            <button id="prev-time-btn" class="px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-lg text-sm" style="color: var(--p-text)">&#9664;</button>
                            <span id="current-range-display" class="px-3 py-1 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium whitespace-nowrap" style="color: var(--p-text)"></span>
                            <button id="next-time-btn" class="px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-lg text-sm" style="color: var(--p-text)">&#9654;</button>
                        </div>

                        <select id="time-range-select" class="p-2 border rounded-lg text-sm smooth-transition w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-violet-500 bg-white dark:bg-slate-800" style="color: var(--p-text); border-color: var(--p-border);">
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="year">Год</option>
                            <option value="all">Все Время</option>
                        </select>
                    </div>

                    <div id="period-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mt-4">
                        <div class="p-4 rounded-lg bg-indigo-50 dark:bg-slate-700 shadow-sm">
                            <i data-lucide="smile" class="w-6 h-6 mx-auto mb-1 text-indigo-600"></i>
                            <div class="text-2xl font-bold" id="avg-mood-summary">0.0</div>
                            <div class="text-xs" style="color: var(--p-text-muted)">Ср. Настроение</div>
                        </div>
                        <div class="p-4 rounded-lg bg-pink-50 dark:bg-slate-700 shadow-sm">
                            <i data-lucide="alert-triangle" class="w-6 h-6 mx-auto mb-1 text-pink-600"></i>
                            <div class="text-2xl font-bold" id="max-stress-summary">0</div>
                            <div class="text-xs" style="color: var(--p-text-muted)">Макс. Стресс</div>
                        </div>
                        <div class="p-4 rounded-lg bg-green-50 dark:bg-slate-700 shadow-sm">
                            <i data-lucide="check-circle" class="w-6 h-6 mx-auto mb-1 text-green-600"></i>
                            <div class="text-2xl font-bold" id="entries-count-summary">0</div>
                            <div class="text-xs" style="color: var(--p-text-muted)">Записей</div>
                        </div>
                        <div class="p-4 rounded-lg bg-yellow-50 dark:bg-slate-700 shadow-sm">
                            <i data-lucide="calendar" class="w-6 h-6 mx-auto mb-1 text-yellow-600"></i>
                            <div class="text-2xl font-bold" id="days-logged-summary">0</div>
                            <div class="text-xs" style="color: var(--p-text-muted)">Дней отслежено</div>
                        </div>
                    </div>
                </div>

                <!-- Графики -->
                <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Анализ Тенденций</h2>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-3" style="color: var(--p-text)">График Настроения</h3>
                        <div id="mood-chart-container" class="chart-container">
                            <canvas id="mood-chart-canvas"></canvas>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-3" style="color: var(--p-text)">График Стресса</h3>
                        <div id="stress-chart-container" class="chart-container">
                            <canvas id="stress-chart-canvas"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Список -->
                <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Все Записи</h2>
                    <ul id="logs-list" class="max-h-96 overflow-y-auto pr-2 space-y-3"></ul>
                </div>
            </div>
        </div>

        <!-- 3. Вкладка "Анализ ИИ" -->
        <div id="analysis" class="view-content">
            <div class="space-y-8">
                <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Настройка Анализа</h2>
                    <label for="ai-instruction" class="block text-sm font-medium mb-1" style="color: var(--p-text-muted)">Системная Инструкция:</label>
                    <textarea id="ai-instruction" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-500 smooth-transition outline-none" placeholder="Действуй как мудрый психолог..."></textarea>
                </div>

                <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Генерация Отчета</h2>
                    <button id="analyze-btn" class="w-full bg-violet-600 text-white font-semibold py-3 rounded-lg hover:bg-violet-700 smooth-transition shadow-md hover:shadow-lg mb-4">
                        Получить Анализ от Gemini AI
                    </button>
                    <div id="analysis-output" class="mt-6 p-4 rounded-lg border min-h-[150px]" style="background-color: var(--p-bg); border-color: var(--p-border)">
                        <p class="italic" style="color: var(--p-text-muted)">Нажмите кнопку для анализа...</p>
                    </div>
                    <div id="citation-container" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-400 text-sm text-blue-800 dark:text-blue-300 rounded-r-lg hidden">
                        <p class="font-semibold mb-1">Источники:</p>
                        <ul id="citations-list" class="list-disc list-inside"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Вкладка "Настройки" -->
        <div id="settings" class="view-content">
            <div class="card-bg p-6 md:p-8 rounded-xl shadow-xl smooth-transition space-y-8">
                
                <!-- Тема и Режим -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Внешний Вид</h2>
                    <div class="flex items-center justify-between mb-4">
                        <span class="font-medium" style="color: var(--p-text)">Темная Тема</span>
                        <button id="settings-theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-slate-700 smooth-transition">
                            <span class="sr-only">Включить темную тему</span>
                            <span id="theme-toggle-dot" class="inline-block h-4 w-4 transform rounded-full bg-white shadow-sm ring-1 ring-slate-900/5 transition duration-200 ease-in-out translate-x-1 dark:translate-x-6"></span>
                        </button>
                    </div>
                    
                    <label class="block text-sm font-medium mb-2 mt-4" style="color: var(--p-text-muted)">Акцентная Тема:</label>
                    <div id="theme-selector" class="flex flex-wrap gap-4">
                        <button data-theme="lavender" class="theme-btn w-10 h-10 rounded-full border-2 border-violet-500 bg-violet-200" title="Лаванда"></button>
                        <button data-theme="sea-breeze" class="theme-btn w-10 h-10 rounded-full border-2 border-transparent bg-cyan-300" title="Морской Бриз"></button>
                        <button data-theme="forest" class="theme-btn w-10 h-10 rounded-full border-2 border-transparent bg-emerald-400" title="Лес"></button>
                        <button data-theme="sunset" class="theme-btn w-10 h-10 rounded-full border-2 border-transparent bg-orange-400" title="Закат"></button>
                        <!-- НОВЫЕ ТЕМЫ -->
                        <button data-theme="deep-blue" class="theme-btn w-10 h-10 rounded-full border-2 border-transparent bg-blue-600" title="Глубокий Синий"></button>
                        <button data-theme="warm-honey" class="theme-btn w-10 h-10 rounded-full border-2 border-transparent bg-yellow-600" title="Теплый Мед"></button>
                        <button data-theme="mint" class="theme-btn w-10 h-10 rounded-full border-2 border-transparent bg-teal-500" title="Мятный"></button>
                    </div>
                </div>

                <!-- Настройка Цветов Шкалы -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Персонализированная Шкала</h2>
                    <p class="text-sm mb-4" style="color: var(--p-text-muted)">Выберите цвета для каждого уровня настроения:</p>
                    <div class="grid grid-cols-5 gap-2 md:gap-4">
                        <div class="flex flex-col items-center">
                            <label class="text-xs mb-1 font-semibold">1</label>
                            <input type="color" id="color-mood-1" class="w-10 h-10 rounded cursor-pointer border-none bg-transparent" value="#EF4444">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-xs mb-1 font-semibold">2</label>
                            <input type="color" id="color-mood-2" class="w-10 h-10 rounded cursor-pointer border-none bg-transparent" value="#F97316">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-xs mb-1 font-semibold">3</label>
                            <input type="color" id="color-mood-3" class="w-10 h-10 rounded cursor-pointer border-none bg-transparent" value="#EAB308">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-xs mb-1 font-semibold">4</label>
                            <input type="color" id="color-mood-4" class="w-10 h-10 rounded cursor-pointer border-none bg-transparent" value="#22C55E">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-xs mb-1 font-semibold">5</label>
                            <input type="color" id="color-mood-5" class="w-10 h-10 rounded cursor-pointer border-none bg-transparent" value="#3B82F6">
                        </div>
                    </div>
                    <button id="reset-colors-btn" class="mt-4 text-xs underline text-gray-500 hover:text-gray-700">Сбросить цвета</button>
                </div>

                <!-- Уведомления -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Уведомления</h2>
                    <div class="flex items-center justify-between mb-4">
                        <span class="font-medium" style="color: var(--p-text)">Ежедневное напоминание</span>
                        <button id="notify-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-slate-700 smooth-transition">
                            <span id="notify-toggle-dot" class="inline-block h-4 w-4 transform rounded-full bg-white shadow-sm ring-1 ring-slate-900/5 transition duration-200 ease-in-out translate-x-1"></span>
                        </button>
                    </div>
                    <div id="notify-time-container" class="opacity-50 pointer-events-none smooth-transition">
                        <label class="block text-sm font-medium mb-1" style="color: var(--p-text-muted)">Время напоминания:</label>
                        <input type="time" id="notify-time" class="p-2 border rounded-lg text-sm bg-white dark:bg-slate-800" style="color: var(--p-text); border-color: var(--p-border);">
                    </div>
                    <p class="text-xs mt-2" style="color: var(--p-text-muted)">* Работает только при открытой вкладке браузера.</p>
                </div>

                <!-- API Key -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--p-accent)">Gemini API</h2>
                    <label for="api-key-input" class="block text-sm font-medium mb-1" style="color: var(--p-text-muted)">API Key:</label>
                    <input type="password" id="api-key-input" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-500 smooth-transition outline-none">
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 hidden z-50">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full smooth-transition transform scale-95 border dark:border-slate-700">
                <h3 id="message-title" class="text-xl font-bold mb-3" style="color: var(--p-text)"></h3>
                <p id="message-content" class="mb-4" style="color: var(--p-text-muted)"></p>
                <button onclick="closeMessageBox()" class="w-full bg-violet-600 text-white font-semibold py-2 rounded-lg hover:bg-violet-700 smooth-transition">OK</button>
            </div>
        </div>
        
        <div id="confirm-box" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 hidden z-50">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full smooth-transition transform scale-95 border dark:border-slate-700">
                <h3 class="text-xl font-bold mb-3 text-red-600">Подтверждение</h3>
                <p class="mb-4" style="color: var(--p-text)">Вы уверены, что хотите удалить эту запись?</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-300 smooth-transition">Отмена</button>
                    <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 smooth-transition">Удалить</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        lucide.createIcons();

        // --- Глобальные Переменные ---
        let currentTheme = 'lavender';
        let isDarkMode = false;
        let moodColors = { 1: '#EF4444', 2: '#F97316', 3: '#EAB308', 4: '#22C55E', 5: '#3B82F6' };
        let logs = [];
        let moodChartInstance = null;
        let stressChartInstance = null;
        let aiSystemInstruction = '';
        let apiKey = '';
        let editingLogId = null;
        let currentRange = 'week';
        let weekOffset = 0; let monthOffset = 0; let yearOffset = 0;
        let currentCalendarDate = new Date(); // Переменная для навигации календаря
        let currentMood = 3; let currentStress = 3;
        
        // Уведомления
        let notifyEnabled = false;
        let notifyTime = '09:00';
        let notificationInterval = null;

        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const clickSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.01, sustain: 0.0, release: 0.05 } }).toDestination();

        // --- Вспомогательные Функции ---
        function playClick() { clickSynth.triggerAttackRelease("C5", "8n", Tone.now(), 0.1); }
        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function formatTime(date) { return date.toTimeString().substring(0, 5); }
        function parseDate(dateString) { 
            const [y, m, d] = dateString.split('-').map(Number); 
            // Use UTC to avoid timezone issues with date-only strings
            return new Date(Date.UTC(y, m - 1, d)); 
        }
        
        function showMessageBox(title, content) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            const el = document.getElementById('message-box'); el.classList.remove('hidden', 'flex'); el.classList.add('flex');
            setTimeout(() => el.querySelector('div').classList.remove('scale-95'), 10);
        }
        window.closeMessageBox = function() {
            const el = document.getElementById('message-box'); el.querySelector('div').classList.add('scale-95');
            setTimeout(() => { el.classList.remove('flex'); el.classList.add('hidden'); }, 200);
        }

        window.showConfirmBox = function(onConfirm) {
            const el = document.getElementById('confirm-box'); el.classList.remove('hidden', 'flex'); el.classList.add('flex');
            setTimeout(() => el.querySelector('div').classList.remove('scale-95'), 10);
            const okBtn = document.getElementById('confirm-ok'); const cancelBtn = document.getElementById('confirm-cancel');
            
            const cleanup = () => {
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                el.querySelector('div').classList.add('scale-95');
                setTimeout(() => { el.classList.remove('flex'); el.classList.add('hidden'); }, 200);
            };
            const handleOk = () => { onConfirm(); cleanup(); };
            const handleCancel = () => { cleanup(); };
            
            okBtn.addEventListener('click', handleOk);
            cancelBtn.addEventListener('click', handleCancel);
        }

        function markdownToHtml(markdown) {
            let html = markdown.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Поддержка Таблиц (Базовая)
            const tableRegex = /\|(.+)\|\n\|[-:| ]+\|\n((?:\|.*\|\n?)+)/g;
            
            html = html.replace(tableRegex, (match, headerRow, bodyRows) => {
                const headers = headerRow.split('|').filter(cell => cell.trim() !== '').map(cell => `<th>${cell.trim()}</th>`).join('');
                
                const rows = bodyRows.trim().split('\n').map(row => {
                    const cells = row.split('|').filter(cell => cell.trim() !== '').map(cell => `<td>${cell.trim()}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                
                return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
            });

            return html.split(/\n\s*\n/g).map(p => (p.startsWith('<') || p.startsWith('|')) ? p : `<p>${p.replace(/\n/g, '<br>')}</p>`).join('')
                   .replace(/^\* (.*$)/gim, '<li>$1</li>').replace(/((?:<li>.*?<\/li>)+)/gs, '<ul>$1</ul>');
        }

        // --- Основная Логика ---

        function loadSettings() {
            currentTheme = localStorage.getItem('appTheme') || 'lavender';
            isDarkMode = localStorage.getItem('isDarkMode') === 'true';
            apiKey = localStorage.getItem('geminiApiKey') || '';
            aiSystemInstruction = localStorage.getItem('aiSystemInstruction') || '';
            const savedColors = localStorage.getItem('moodColors');
            if (savedColors) moodColors = JSON.parse(savedColors);
            
            notifyEnabled = localStorage.getItem('notifyEnabled') === 'true';
            notifyTime = localStorage.getItem('notifyTime') || '20:00';

            // Применение настроек
            applyTheme(currentTheme);
            applyDarkMode(isDarkMode);
            applyMoodColors();
            updateNotifyUI();
            checkNotificationPermission();

            document.getElementById('api-key-input').value = apiKey;
            document.getElementById('ai-instruction').value = aiSystemInstruction;
            
            // Заполнение инпутов цветов
            for(let i=1; i<=5; i++) document.getElementById(`color-mood-${i}`).value = moodColors[i];
        }
        
        function saveSettings() {
            apiKey = document.getElementById('api-key-input').value.trim();
            aiSystemInstruction = document.getElementById('ai-instruction').value.trim();
            localStorage.setItem('geminiApiKey', apiKey);
            localStorage.setItem('aiSystemInstruction', aiSystemInstruction);
            // Цвета сохраняются сразу при изменении
        }

        // --- Темы и Цвета ---

        function applyTheme(themeName) {
            const themes = {
                'lavender': { '--p-accent': '#8B5CF6', '--p-accent-light': '#EDE9FE' },
                'sea-breeze': { '--p-accent': '#06B6D4', '--p-accent-light': '#CFFAFE' },
                'sunset': { '--p-accent': '#F59E0B', '--p-accent-light': '#FEF3C7' },
                'forest': { '--p-accent': '#10B981', '--p-accent-light': '#D1FAE5' },
                // НОВЫЕ ТЕМЫ
                'deep-blue': { '--p-accent': '#3B82F6', '--p-accent-light': '#DBEAFE' },
                'warm-honey': { '--p-accent': '#FBBF24', '--p-accent-light': '#FFFBEB' },
                'mint': { '--p-accent': '#14B8A6', '--p-accent-light': '#CCFBF1' }
            };
            const theme = themes[themeName];
            const root = document.documentElement;
            
            const isDark = document.documentElement.classList.contains('dark-mode');
            
            root.style.setProperty('--p-accent', theme['--p-accent']);
            // В темной теме accent-light должен быть темнее
            if (!isDark) root.style.setProperty('--p-accent-light', theme['--p-accent-light']);
            
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('border-4', 'border-gray-500', 'border-transparent'));
            const activeBtn = document.querySelector(`.theme-btn[data-theme="${themeName}"]`);
            if(activeBtn) activeBtn.classList.add('border-4', 'border-gray-500');
            
            currentTheme = themeName;
            localStorage.setItem('appTheme', themeName);
            renderChart(); // Обновить цвета графика
        }

        function applyDarkMode(enabled) {
            const body = document.body;
            const toggleDot = document.getElementById('theme-toggle-dot');
            const icons = document.getElementById('global-theme-toggle').children;

            if (enabled) {
                body.classList.add('dark-mode');
                document.documentElement.classList.add('dark-mode');
                toggleDot.classList.add('translate-x-6');
                toggleDot.classList.remove('translate-x-1');
                icons[0].classList.add('hidden'); icons[1].classList.remove('hidden');
                // Корректировка accent-light для темной темы
                document.documentElement.style.setProperty('--p-accent-light', '#1e293b');
            } else {
                body.classList.remove('dark-mode');
                document.documentElement.classList.remove('dark-mode');
                toggleDot.classList.add('translate-x-1');
                toggleDot.classList.remove('translate-x-6');
                icons[1].classList.add('hidden'); icons[0].classList.remove('hidden');
                // Возврат accent-light текущей темы
                applyTheme(currentTheme);
            }
            isDarkMode = enabled;
            localStorage.setItem('isDarkMode', enabled);
        }

        function applyMoodColors() {
            // 1. Генерация кнопок настроения
            const container = document.getElementById('mood-selector');
            container.innerHTML = '';
            const titles = ['Ужасно', 'Плохо', 'Нормально', 'Хорошо', 'Отлично'];
            
            for(let i=1; i<=5; i++) {
                const color = moodColors[i];
                const btn = document.createElement('button');
                btn.className = `mood-btn flex flex-col items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full aspect-square smooth-transition`;
                btn.dataset.mood = i;
                btn.title = titles[i-1];
                btn.textContent = i;
                
                btn.style.color = color;
                btn.style.border = `2px solid ${color}40`;
                btn.style.backgroundColor = `${color}15`;
                
                container.appendChild(btn);
            }
            
            // 2. Обновление линейки визуализации
            document.querySelectorAll('.mood-scale-segment').forEach(segment => {
                const mood = segment.dataset.mood;
                segment.style.backgroundColor = moodColors[mood];
            });

            if (logs.length > 0) {
                renderCalendar(currentCalendarDate);
                renderChart();
            }
            updateMoodBtnStyles(); // Обновить стили активной кнопки
        }
        
        window.updateMoodBtnStyles = function() {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                const mood = parseInt(btn.dataset.mood);
                const color = moodColors[mood];
                if (parseInt(currentMood) === mood) {
                    btn.style.boxShadow = `0 0 0 4px ${color}30, 0 0 0 6px ${color}`;
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.style.boxShadow = 'none';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        // --- Уведомления ---
        
        function updateNotifyUI() {
            const dot = document.getElementById('notify-toggle-dot');
            const timeContainer = document.getElementById('notify-time-container');
            const timeInput = document.getElementById('notify-time');
            
            timeInput.value = notifyTime;
            
            if (notifyEnabled) {
                dot.classList.add('translate-x-6'); dot.classList.remove('translate-x-1');
                timeContainer.classList.remove('opacity-50', 'pointer-events-none');
                startNotificationTimer();
            } else {
                dot.classList.add('translate-x-1'); dot.classList.remove('translate-x-6');
                timeContainer.classList.add('opacity-50', 'pointer-events-none');
                stopNotificationTimer();
            }
        }
        
        function checkNotificationPermission() {
            if (notifyEnabled && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission !== 'granted') {
                        notifyEnabled = false;
                        updateNotifyUI();
                        showMessageBox('Разрешение', 'Для работы напоминаний требуется разрешение на уведомления.');
                    }
                });
            }
        }

        function startNotificationTimer() {
            if (notificationInterval) clearInterval(notificationInterval);
            notificationInterval = setInterval(() => {
                const now = new Date();
                const currentTime = now.toTimeString().substring(0, 5);
                if (currentTime === notifyTime && now.getSeconds() < 10) {
                    new Notification("Дневник Настроения", { 
                        body: "Время записать, как прошел ваш день!",
                        icon: "https://placehold.co/128x128/8B5CF6/ffffff?text=Mood"
                    });
                }
            }, 10000); // Проверка каждые 10 сек
        }

        function stopNotificationTimer() {
            if (notificationInterval) clearInterval(notificationInterval);
        }


        // --- Логика Данных ---

        function loadData() {
            const stored = localStorage.getItem('moodLogs');
            logs = stored ? JSON.parse(stored) : [];
            // Сортировка по дате И времени
            logs.sort((a, b) => {
                const dtA = new Date(a.date + 'T' + (a.exactTime || '00:00'));
                const dtB = new Date(b.date + 'T' + (b.exactTime || '00:00'));
                return dtA - dtB;
            });
            renderLogs(); renderChart(); renderCalendar(currentCalendarDate);
            updatePeriodSummary(); // Обновление сводки
        }

        function saveLog() {
            playClick();
            const date = document.getElementById('log-date').value;
            const time = document.getElementById('log-time').value;
            const note = document.getElementById('log-note').value.trim();
            
            if (!date || !time) { showMessageBox("Ошибка", "Укажите дату и время."); return; }

            const logId = editingLogId || Date.now();
            const newLog = {
                id: logId,
                date: date,
                exactTime: time, 
                time: time,
                mood: currentMood,
                stress: currentStress,
                note: note
            };

            const idx = logs.findIndex(l => l.id === logId);
            if (idx !== -1) logs[idx] = { ...logs[idx], ...newLog };
            else logs.push(newLog);

            localStorage.setItem('moodLogs', JSON.stringify(logs));
            loadData();
            resetForm();
            showMessageBox("Успех", "Запись сохранена.");
        }
        
        function resetForm() {
            editingLogId = null;
            document.getElementById('entry-title').textContent = 'Ежедневная Запись';
            document.getElementById('save-log-btn').textContent = 'Сохранить Запись';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('log-note').value = '';
            
            const now = new Date();
            document.getElementById('log-date').value = formatDate(now);
            document.getElementById('log-time').value = formatTime(now);
            
            selectMood(3); selectStress(3);
        }
        
        window.editNote = function(id) {
            const log = logs.find(l => l.id === id);
            if (!log) return;
            document.querySelector('.tab-btn[data-target="log-entry"]').click();
            
            editingLogId = id;
            document.getElementById('entry-title').textContent = 'Редактирование';
            document.getElementById('save-log-btn').textContent = 'Обновить';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            document.getElementById('log-date').value = log.date;
            document.getElementById('log-time').value = log.exactTime || log.time || '12:00';
            document.getElementById('log-note').value = log.note;
            selectMood(log.mood); selectStress(log.stress);
        }

        window.deleteNote = function(id) {
            showConfirmBox(() => {
                logs = logs.filter(l => l.id !== id);
                localStorage.setItem('moodLogs', JSON.stringify(logs));
                loadData();
            });
        }
        
        window.selectMood = function(mood) {
            currentMood = mood;
            updateMoodBtnStyles();
            playClick();
        }
        window.selectStress = function(stress) {
            currentStress = stress;
            document.querySelectorAll('.stress-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.stress-btn[data-stress="${stress}"]`)?.classList.add('active');
            playClick();
        }

        // --- Визуализация ---

        function renderCalendar(targetDate) {
            const year = targetDate.getFullYear(); 
            const month = targetDate.getMonth();
            document.getElementById('current-calendar-month').textContent = targetDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay(); 
            const startOffset = (firstDay + 6) % 7; 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = `<div class="grid grid-cols-7 text-center font-bold text-xs mb-2 text-gray-500">
                <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div class="text-red-400">Сб</div><div class="text-red-400">Вс</div></div>
                <div class="grid grid-cols-7 gap-1">`;
            
            for(let i=0; i<startOffset; i++) html += `<div></div>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayLogs = logs.filter(l => l.date === dateStr);
                
                let bgStyle = 'background-color: transparent; border: 1px solid var(--p-border);';
                let content = `<span style="color: var(--p-text)">${d}</span>`;
                
                if (dayLogs.length > 0) {
                    const avgMood = Math.round(dayLogs.reduce((s, l) => s + l.mood, 0) / dayLogs.length);
                    const color = moodColors[avgMood];
                    // Используем кастомный цвет с прозрачностью для фона
                    bgStyle = `background-color: ${color}30; border: 1px solid ${color}; color: ${color}; font-weight: bold;`;
                    content = `<span>${d}</span><span class="block text-[10px] opacity-80">${avgMood}/5</span>`;
                }
                
                // Подсветка сегодня
                const isToday = dateStr === formatDate(new Date());
                const todayClass = isToday ? 'ring-2 ring-violet-500' : '';
                
                html += `<div class="calendar-day-cell p-1 h-12 rounded flex flex-col items-center justify-center ${todayClass}" 
                        style="${bgStyle}" onclick="promptToCreateLog('${dateStr}')">${content}</div>`;
            }
            html += `</div>`;
            document.getElementById('calendar-grid').innerHTML = html;
        }
        
        // --- Сводка Периода (НОВАЯ ФУНКЦИЯ) ---
        function updatePeriodSummary() {
            let filteredLogs = [];
            const now = new Date();
            let dateRange = { start: null, end: null };

            if (currentRange === 'week') {
                let currentWeekStart = new Date(now);
                const day = currentWeekStart.getDay() || 7; 
                if (day !== 1) currentWeekStart.setHours(-24 * (day - 1));
                else currentWeekStart.setHours(0,0,0,0);
                
                currentWeekStart.setDate(currentWeekStart.getDate() + (weekOffset * 7));
                
                dateRange.start = formatDate(currentWeekStart);
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                dateRange.end = formatDate(weekEnd);

            } else if (currentRange === 'month') {
                let targetMonth = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
                const daysInMonth = new Date(targetMonth.getFullYear(), targetMonth.getMonth() + 1, 0).getDate();
                
                dateRange.start = formatDate(targetMonth);
                const monthEnd = new Date(targetMonth);
                monthEnd.setDate(daysInMonth);
                dateRange.end = formatDate(monthEnd);

            } else if (currentRange === 'year') {
                let targetYear = now.getFullYear() + yearOffset;
                
                dateRange.start = `${targetYear}-01-01`;
                dateRange.end = `${targetYear}-12-31`;

            } else { // All time
                filteredLogs = logs;
            }
            
            if (dateRange.start && dateRange.end) {
                filteredLogs = logs.filter(log => log.date >= dateRange.start && log.date <= dateRange.end);
            }
            
            // Расчет метрик
            const totalMood = filteredLogs.reduce((sum, log) => sum + log.mood, 0);
            const totalStress = filteredLogs.reduce((sum, log) => sum + log.stress, 0);
            const maxStress = filteredLogs.reduce((max, log) => Math.max(max, log.stress), 0);
            const entryCount = filteredLogs.length;
            
            const uniqueDates = new Set(filteredLogs.map(log => log.date)).size;
            
            const avgMood = entryCount > 0 ? (totalMood / entryCount).toFixed(1) : '0.0';
            
            document.getElementById('avg-mood-summary').textContent = avgMood;
            document.getElementById('max-stress-summary').textContent = maxStress;
            document.getElementById('entries-count-summary').textContent = entryCount;
            document.getElementById('days-logged-summary').textContent = uniqueDates;
        }

        // ИСПРАВЛЕНИЕ: Логика графиков теперь использует фиксированные диапазоны
        function renderChart() {
            if(moodChartInstance) moodChartInstance.destroy();
            if(stressChartInstance) stressChartInstance.destroy();
            
            updatePeriodSummary(); // Обновляем сводку при смене диапазона
            
            const now = new Date();
            let labels = [];
            let chartMoodData = [];
            let chartStressData = [];
            let displayRange = "";

            const rangeDisplay = document.getElementById('current-range-display');

            // Вспомогательная функция для получения логов за дату
            const getLogForDate = (dStr) => {
                const dayLogs = logs.filter(l => l.date === dStr);
                if (dayLogs.length === 0) return null;
                const avgMood = dayLogs.reduce((s, l) => s + l.mood, 0) / dayLogs.length;
                const avgStress = dayLogs.reduce((s, l) => s + l.stress, 0) / dayLogs.length;
                return { mood: avgMood, stress: avgStress };
            };

            if (currentRange === 'week') {
                // Вычисляем начало недели (Понедельник)
                let currentWeekStart = new Date(now);
                const day = currentWeekStart.getDay() || 7; 
                if (day !== 1) currentWeekStart.setHours(-24 * (day - 1));
                else currentWeekStart.setHours(0,0,0,0);
                
                // Применяем смещение
                currentWeekStart.setDate(currentWeekStart.getDate() + (weekOffset * 7));
                
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                displayRange = `${currentWeekStart.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' })}`;

                // Генерируем 7 дней
                for(let i=0; i<7; i++) {
                    let d = new Date(currentWeekStart);
                    d.setDate(d.getDate() + i);
                    const dStr = formatDate(d);
                    const dayData = getLogForDate(dStr);
                    
                    const dayName = d.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric' });
                    labels.push(dayName);
                    
                    chartMoodData.push(dayData ? dayData.mood : null);
                    chartStressData.push(dayData ? dayData.stress : null);
                }

            } else if (currentRange === 'month') {
                let targetMonth = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
                displayRange = targetMonth.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
                
                const daysInMonth = new Date(targetMonth.getFullYear(), targetMonth.getMonth() + 1, 0).getDate();
                
                for(let i=1; i<=daysInMonth; i++) {
                    let dStr = `${targetMonth.getFullYear()}-${String(targetMonth.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    labels.push(i); // Просто число месяца
                    const dayData = getLogForDate(dStr);
                    chartMoodData.push(dayData ? dayData.mood : null);
                    chartStressData.push(dayData ? dayData.stress : null);
                }

            } else if (currentRange === 'year') {
                let targetYear = now.getFullYear() + yearOffset;
                displayRange = targetYear.toString();
                
                for(let i=0; i<12; i++) {
                    const monthName = new Date(targetYear, i).toLocaleDateString('ru-RU', { month: 'short' });
                    labels.push(monthName);
                    
                    const monthLogs = logs.filter(l => {
                        const ld = parseDate(l.date);
                        return ld.getFullYear() === targetYear && ld.getMonth() === i;
                    });
                    
                    if (monthLogs.length > 0) {
                         chartMoodData.push(monthLogs.reduce((s,l)=>s+l.mood,0)/monthLogs.length);
                         chartStressData.push(monthLogs.reduce((s,l)=>s+l.stress,0)/monthLogs.length);
                    } else {
                        chartMoodData.push(null);
                        chartStressData.push(null);
                    }
                }
            } else { // All time
                displayRange = "Все Время";
                const sorted = [...logs].sort((a,b) => parseDate(a.date) - parseDate(b.date));
                const uniqueDates = [...new Set(sorted.map(l => l.date))];
                uniqueDates.forEach(dStr => {
                     labels.push(dStr);
                     const dayData = getLogForDate(dStr);
                     chartMoodData.push(dayData.mood);
                     chartStressData.push(dayData.stress);
                });
            }
            
            rangeDisplay.textContent = displayRange;

            const accent = getComputedStyle(document.documentElement).getPropertyValue('--p-accent').trim();
            
            const commonOptions = {
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { 
                        min:1, max:5, 
                        ticks: { stepSize: 1 }, 
                        grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--p-border').trim() }
                    }, 
                    x: { 
                        ticks: { autoSkip: true, maxTicksLimit: 10 },
                        grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--p-border').trim() }
                    } 
                },
                plugins: {
                    legend: { display: false } 
                },
                spanGaps: true 
            };

            const moodCtx = document.getElementById('mood-chart-canvas').getContext('2d');
            moodChartInstance = new Chart(moodCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Настроение',
                        data: chartMoodData,
                        borderColor: accent,
                        backgroundColor: accent + '40',
                        pointRadius: 4,
                        segment: {
                            borderColor: ctx => {
                                if (ctx.p1.parsed.y === null) return 'transparent';
                                const val = ctx.p1.parsed.y;
                                return moodColors[Math.round(val)] || accent;
                            }
                        },
                        pointBackgroundColor: ctx => moodColors[Math.round(ctx.raw)] || accent
                    }]
                },
                options: commonOptions
            });
            
            const stressCtx = document.getElementById('stress-chart-canvas').getContext('2d');
            stressChartInstance = new Chart(stressCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Стресс',
                        data: chartStressData,
                        borderColor: '#EF4444',
                        backgroundColor: '#EF444440',
                        pointRadius: 4,
                        pointBackgroundColor: '#EF4444'
                    }]
                },
                options: commonOptions
            });
        }
        
        function renderLogs() {
            const list = document.getElementById('logs-list');
            list.innerHTML = '';
            logs.slice().reverse().forEach(log => {
                const li = document.createElement('li');
                li.className = 'flex items-start p-4 rounded-xl card-bg smooth-transition hover:shadow-md';
                
                const moodCol = moodColors[log.mood];
                
                li.innerHTML = `
                    <div class="flex-shrink-0 w-16 text-center border-r pr-4 mr-4" style="border-color: var(--p-border)">
                        <div class="text-xs font-bold opacity-60" style="color: var(--p-text-muted)">${log.date}</div>
                        <div class="text-xs font-bold opacity-60" style="color: var(--p-text-muted)">${log.exactTime || ''}</div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-0.5 rounded text-xs font-bold text-white" style="background-color: ${moodCol}">M: ${log.mood}</span>
                            <span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300">S: ${log.stress}</span>
                        </div>
                        <p class="text-sm text-ellipsis overflow-hidden whitespace-nowrap" style="color: var(--p-text)">${log.note || "Нет заметки"}</p>
                    </div>

                    <div class="flex flex-col gap-2 ml-4 flex-shrink-0">
                        <button onclick="editNote(${log.id})" class="p-1 rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i data-lucide="edit-2" width="16"></i></button>
                        <button onclick="deleteNote(${log.id})" class="p-1 rounded-full text-red-400 hover:text-red-600 dark:hover:text-red-300"><i data-lucide="trash" width="16"></i></button>
                    </div>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        window.promptToCreateLog = function(date) {
            document.getElementById('log-date').value = date;
            document.querySelector('.tab-btn[data-target="log-entry"]').click();
        }

        // --- Gemini AI (Полная Логика) ---
        async function fetchGeminiAnalysis() {
             if(!apiKey) { showMessageBox("Ошибка", "Пожалуйста, введите ваш Gemini API Key во вкладке 'Настройки'."); return; }
             if (logs.length === 0) { showMessageBox("Инфо", "Нет данных для анализа. Сделайте хотя бы одну запись."); return; }
             
             const btn = document.getElementById('analyze-btn');
             const outputElement = document.getElementById('analysis-output');
             const citationContainer = document.getElementById('citation-container');
             const citationList = document.getElementById('citations-list');
             
             const originalText = btn.textContent;
             btn.textContent = "Анализирую..."; btn.disabled = true;
             outputElement.innerHTML = '<p class="text-gray-500 italic">... Идет анализ данных. Пожалуйста, подождите. ...</p>';
             citationContainer.classList.add('hidden');
             citationList.innerHTML = '';
             
             // Формируем промпт
             const dataForAI = logs.slice(-30).map(log => 
                `[${log.date} ${log.exactTime || ''}] Настроение: ${log.mood}/5, Стресс: ${log.stress}/5, Заметка: ${log.note}`
             ).join('\n');

             const userQuery = `Проанализируй следующий дневник настроения. Дай оценку тенденциям и предложи рекомендации. Формат Markdown. Если уместно, используй таблицы.\n\nДанные:\n${dataForAI}`;
             
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
             const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: aiSystemInstruction || "Ты полезный психологический помощник. Всегда давай полезные и конкретные рекомендации." }] }
             };
             
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    outputElement.innerHTML = markdownToHtml(text);
                } else {
                    outputElement.textContent = "Не удалось получить ответ от модели.";
                }
             } catch (e) {
                console.error(e);
                outputElement.textContent = `Ошибка: ${e.message}`;
             } finally {
                btn.textContent = originalText; btn.disabled = false;
             }
        }

        document.getElementById('analyze-btn').addEventListener('click', fetchGeminiAnalysis);


        // --- Инит ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            resetForm();
            loadData();
            
            // Обработчики кнопок настроения и стресса
            document.getElementById('mood-selector').addEventListener('click', (e) => {
                const btn = e.target.closest('.mood-btn');
                if (btn) { selectMood(parseInt(btn.dataset.mood)); }
            });

            document.getElementById('stress-selector').addEventListener('click', (e) => {
                const btn = e.target.closest('.stress-btn');
                if (btn) { selectStress(parseInt(btn.dataset.stress)); }
            });
            
            // Табы
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 document.querySelectorAll('.tab-btn').forEach(b => {
                     b.classList.remove('bg-gray-100', 'dark:bg-slate-700');
                     b.style.color = 'var(--p-text)';
                 });
                 e.target.classList.add('bg-gray-100', 'dark:bg-slate-700');
                 e.target.style.color = 'var(--p-accent)';
                 
                 document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active-view'));
                 document.getElementById(e.target.dataset.target).classList.add('active-view');

                 // Обновляем графики при переключении на вкладку logs
                 if (e.target.dataset.target === 'logs') {
                    renderChart();
                    updatePeriodSummary();
                 }
            }));
            document.querySelector('.tab-btn[data-target="log-entry"]').click();

            // Обработчики настроек
            document.getElementById('global-theme-toggle').addEventListener('click', () => applyDarkMode(!isDarkMode));
            document.getElementById('settings-theme-toggle').addEventListener('click', () => applyDarkMode(!isDarkMode));
            
            document.getElementById('theme-selector').addEventListener('click', (e) => {
                if(e.target.classList.contains('theme-btn')) applyTheme(e.target.dataset.theme);
            });
            
            // Цвета
            for(let i=1; i<=5; i++) {
                document.getElementById(`color-mood-${i}`).addEventListener('input', (e) => {
                    moodColors[i] = e.target.value;
                    localStorage.setItem('moodColors', JSON.stringify(moodColors));
                    applyMoodColors();
                });
            }
            document.getElementById('reset-colors-btn').addEventListener('click', () => {
                moodColors = { 1: '#EF4444', 2: '#F97316', 3: '#EAB308', 4: '#22C55E', 5: '#3B82F6' };
                localStorage.setItem('moodColors', JSON.stringify(moodColors));
                for(let i=1; i<=5; i++) document.getElementById(`color-mood-${i}`).value = moodColors[i];
                applyMoodColors();
            });

            // Уведомления
            document.getElementById('notify-toggle').addEventListener('click', () => {
                notifyEnabled = !notifyEnabled;
                localStorage.setItem('notifyEnabled', notifyEnabled);
                updateNotifyUI();
                checkNotificationPermission();
            });
            document.getElementById('notify-time').addEventListener('change', (e) => {
                notifyTime = e.target.value;
                localStorage.setItem('notifyTime', notifyTime);
                if(notifyEnabled) startNotificationTimer();
            });

            // API
            document.getElementById('api-key-input').addEventListener('change', saveSettings);
            document.getElementById('ai-instruction').addEventListener('change', saveSettings);
            
            // Логи
            document.getElementById('save-log-btn').addEventListener('click', saveLog);
            document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);

            // Обработчики Графиков (Единая навигация) 
            document.getElementById('time-range-select').addEventListener('change', (e) => {
                currentRange = e.target.value;
                weekOffset = 0; monthOffset = 0; yearOffset = 0; 
                renderChart();
                playClick();
            });

            document.getElementById('prev-time-btn').addEventListener('click', () => {
                if (currentRange === 'week') weekOffset--;
                else if (currentRange === 'month') monthOffset--;
                else if (currentRange === 'year') yearOffset--;
                renderChart();
                playClick();
            });

            document.getElementById('next-time-btn').addEventListener('click', () => {
                if (currentRange === 'week') weekOffset++;
                else if (currentRange === 'month') monthOffset++;
                else if (currentRange === 'year') yearOffset++;
                renderChart();
                playClick();
            });
            
            // Обработчики Календаря
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate);
                playClick();
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate);
                playClick();
            });
        });
    </script>
</body>
</html>
